select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '12981','86812','43664','89175','80088','19296',
                          '22439','86437','78152','17274','59042',
                          '64229','18986','89883','46454','66046',
                          '28512','54311','32509','42684','11918',
                          '57386','55960','13267','90112','70984',
                          '64269','84212','72442','92105','71665',
                          '97016','59165','53026','31179','60805',
                          '14155','78956','95340','32607','17000',
                          '58004','97992','20784','14228','72374',
                          '35824','37090','74330','53408','32944',
                          '62194','15731','47840','80628','29505',
                          '46967','65892','67959','77905','31685',
                          '80960','66204','64752','40872','45697',
                          '28296','64119','71136','53554','77239',
                          '18599','32373','73986','88808','60940',
                          '27732','14579','92876','73063','65371',
                          '82308','89006','93274','72161','11771',
                          '92909','50753','27010','35579','93246',
                          '64711','91000','95778','23388','63514',
                          '93739','23671','69330','79069','90791',
                          '29344','94582','86685','93286','53889',
                          '53181','90101','24732','87933','49376',
                          '97017','35980','64520','91216','81774',
                          '12040','43438','14930','34582','61785',
                          '64400','14864','63885','24410','18756',
                          '90746','90773','23717','58027','76766',
                          '12669','78903','82146','57721','93223',
                          '78755','10325','47612','45124','54673',
                          '97711','89641','52929','70616','87768',
                          '12601','41934','72289','53793','28370',
                          '63153','63742','13259','79893','92236',
                          '67086','51568','41420','36290','22950',
                          '44784','34127','80659','36778','49630',
                          '85785','15391','83146','62169','64528',
                          '56202','17008','97687','64498','98323',
                          '35683','87816','69792','98038','11330',
                          '68173','18833','66951','52330','27899',
                          '59257','86869','46516','33810','26093',
                          '60401','76075','99521','74476','58587',
                          '27781','78809','90261','41347','20882',
                          '74522','26252','33488','73572','75781',
                          '93406','33611','96218','54223','54305',
                          '79975','60974','59868','55189','94471',
                          '66959','75177','96390','74698','10379',
                          '91274','87641','80294','67846','41240',
                          '75566','38022','53231','27667','44193',
                          '97747','28732','62154','77187','43384',
                          '25012','78432','13579','44950','70670',
                          '67294','67943','63761','10813','32289',
                          '93323','55862','77982','81222','27657',
                          '24602','17880','33573','93818','81347',
                          '72736','12060','75391','23490','99473',
                          '45361','20589','66594','35487','88247',
                          '85014','98086','42980','37996','26409',
                          '85464','69191','17122','37181','21934',
                          '61983','59931','93503','58658','77299',
                          '73760','46668','83292','70771','41135',
                          '89488','96318','11722','31903','35422',
                          '48763','22970','33305','40799','35293',
                          '33823','61212','50373','26751','54122',
                          '63574','38958','61978','22322','41457',
                          '43926','87687','24733','56240','96302',
                          '65480','38338','45606','64774','61973',
                          '40407','45617','10029','14577','79434',
                          '41865','36529','82686','14427','96697',
                          '96895','44221','84589','23226','81372',
                          '46085','54254','19775','90399','47591',
                          '86809','50031','62610','30513','61889',
                          '58338','31158','56378','47081','84176',
                          '55415','23977','65838','72585','11479',
                          '45461','99481','61108','65304','36298',
                          '60441','81526','29749','47238','27608',
                          '95142','85376','31738','87456','40339',
                          '43228','75960','52568','14329','30133',
                          '43126','80229','24406','99719','89381',
                          '79836','66812','10909','80832','34781',
                          '90517','65479','10814','51612','59338',
                          '60876','39632','41054','60929','54494',
                          '75445','56259','96366','11152','54978',
                          '46543','22460','15866','71529')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;