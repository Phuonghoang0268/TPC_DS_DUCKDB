select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '14585','84827','22249','31567','32506','88891',
                          '47861','32384','56565','74745','32544',
                          '77499','65657','16737','47751','16854',
                          '11798','24350','96258','43544','32628',
                          '60858','29726','98043','43716','42251',
                          '51246','36928','58723','92524','94772',
                          '57585','22492','34650','32369','27063',
                          '28756','27403','98667','42555','66667',
                          '94103','73984','94835','39156','70346',
                          '59059','49506','36838','49516','72676',
                          '12246','92412','10666','24460','97716',
                          '32430','96662','40384','32335','15240',
                          '77940','86290','39088','47741','66904',
                          '93092','69107','31723','97671','36770',
                          '56084','84110','36823','45186','76530',
                          '17633','87902','77482','82696','77155',
                          '34734','46048','28317','96747','10747',
                          '12836','20913','73082','93091','85049',
                          '38579','85467','19185','43036','98778',
                          '22844','13889','40640','23066','66952',
                          '35743','12590','63466','51835','80964',
                          '16868','66388','71644','73467','87634',
                          '69615','11663','82037','95854','52534',
                          '95557','64160','68661','46011','29527',
                          '80076','76741','83601','31302','29301',
                          '70996','30518','79367','63953','37355',
                          '34092','88934','99137','52643','12325',
                          '59472','57381','90669','65973','66442',
                          '48528','15871','40596','13507','44261',
                          '20084','57032','23004','97089','54838',
                          '66010','22063','94574','12846','88394',
                          '13794','67770','54572','54906','48678',
                          '25945','75779','24206','65925','18318',
                          '58507','58613','26353','40765','40176',
                          '33893','32757','99037','79343','11597',
                          '33230','26738','17802','38016','56987',
                          '77962','42557','47017','52475','89757',
                          '28326','43120','18694','27348','70816',
                          '86789','31080','75364','97010','62472',
                          '44631','54892','41715','54543','73757',
                          '47570','26001','96095','62843','55009',
                          '76524','84156','12297','24447','32286',
                          '42381','97414','14878','57301','54347',
                          '63729','83373','16327','12095','93326',
                          '70058','45159','33289','63399','42543',
                          '80344','80789','19917','97950','36031',
                          '33167','18763','35038','79249','12356',
                          '32143','54360','91573','17745','88904',
                          '97057','90767','38441','74683','47606',
                          '64091','48276','61491','38199','24542',
                          '47007','65360','65992','59932','39116',
                          '93248','56617','80296','37074','28182',
                          '32219','67339','35575','48883','82881',
                          '78720','85122','91685','92686','59745',
                          '26196','87697','24548','19098','10285',
                          '35671','52254','26533','57891','51874',
                          '25994','24611','71342','59396','68157',
                          '53006','71421','66068','54611','73144',
                          '69480','67003','65864','79074','38587',
                          '55342','25886','33749','86828','64884',
                          '60682','86817','86138','92438','26867',
                          '31069','22086','34735','93332','94358',
                          '15517','37442','82883','44306','32787',
                          '28801','38745','57784','70233','17028',
                          '65321','17549','32997','96581','62609',
                          '68230','58422','75348','68103','92430',
                          '44979','21732','38007','49026','91298',
                          '18835','92457','16405','10076','22276',
                          '26301','54383','31851','67213','99212',
                          '46791','70670','71006','28382','64185',
                          '33284','97201','19767','44927','35796',
                          '39868','33600','62109','33624','78153',
                          '19423','49695','87223','58001','39701',
                          '93025','30716','44548','71662','31435',
                          '31199','45743','70041','31152','73105',
                          '81059','43050','85074','10752','26992',
                          '37596','55819','15471','75875','42361',
                          '56761','31724','59351','34129','23315',
                          '96202','10171','66364','89379','34276',
                          '18391','99194','34614','73564')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;